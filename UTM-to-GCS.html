<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UTM ⇄ Lat/Lon (WGS84) — Two-Way Converter</title>

<!-- Theme bootstrap -->
<script>
(function(){
  try{
    const saved = localStorage.getItem('themeOverride');
    const theme = (saved==='light'||saved==='dark') ? saved :
      (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
    document.documentElement.setAttribute('data-theme', theme);
  }catch(e){ document.documentElement.setAttribute('data-theme','light'); }
})();
</script>

<style>
/* ---------- THEME ---------- */
:root{
  --bg:#eef1f6; --fg:#111827; --card:#ffffff; --muted:#6b7280;
  --acc:#0b74ff; --ok:#16a34a; --warn:#b45309; --err:#ef4444;
  --border: rgba(0,0,0,.1);
  --shadow: 0 10px 30px rgba(0,0,0,.12);
}
[data-theme="dark"]{
  --bg:#0b0c10; --fg:#e5e7eb; --card:#15171d; --muted:#a9b1ba;
  --acc:#3aa1ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  --border: rgba(255,255,255,.12);
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

/* ---------- LAYOUT ---------- */
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--fg);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}
.wrap{max-width:1180px;margin:0 auto;padding:20px 16px 90px;position:relative}
h1{font-size:clamp(22px,2.4vw,30px);margin:6px 0 14px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:980px){.grid{grid-template-columns:420px 1fr}}
.card{background:var(--card);border:1px solid var(--border);
  border-radius:16px;box-shadow:var(--shadow);padding:16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
label{font-size:13px;color:var(--muted)}
input[type="number"],input[type="text"],select{
  width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--fg)
}
input[type="file"]{width:100%}
.hint{font-size:12px;color:var(--muted)}
.section-title{font-weight:700;margin:10px 0 6px}
.btn{appearance:none;border:none;border-radius:14px;padding:12px 16px;
  font-weight:600;cursor:pointer;transition:.2s;background:var(--acc);color:white}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.btn.secondary{background:#3b3f46}
[data-theme="light"] .btn.secondary{background:#3b3f46}
[data-theme="dark"] .btn.secondary{background:#3b3f46}
.btn.ok{background:var(--ok)} .btn.warn{background:var(--warn)} .btn.err{background:var(--err)}
.stack{display:flex;gap:10px;flex-wrap:wrap}

.table-wrap{max-height:420px;overflow:auto;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px 12px;border-bottom:1px solid rgba(127,127,127,.14)}
th{position:sticky;top:0;background:var(--card);z-index:1}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(58,161,255,.14);color:var(--acc);font-size:12px;margin-left:6px}
.error{padding:10px 12px;border-radius:12px;background:rgba(239,68,68,.12);color:var(--err);font-size:13px}
.success{padding:10px 12px;border-radius:12px;background:rgba(34,197,94,.12);color:var(--ok);font-size:13px}

/* Map */
.map{height:360px;border-radius:12px;border:1px solid var(--border)}
details{border:1px dashed var(--border);padding:10px 12px;border-radius:12px}
summary{cursor:pointer;font-weight:600}

/* Toolbar / Theme selector */
.toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.theme-ctl{display:flex;gap:8px;align-items:center}
.theme-btn{display:inline-flex;align-items:center;gap:8px;background:transparent;border:1px solid var(--border);
  color:var(--fg);padding:8px 12px;border-radius:999px;cursor:pointer}
.theme-btn:hover{box-shadow:0 1px 8px rgba(0,0,0,.12)}
.ico{width:18px;height:18px;display:inline-block}

/* Credit */
.credit{position:fixed;right:14px;bottom:12px;font-size:12px;color:var(--muted);
  background:var(--card);border:1px solid var(--border);
  padding:6px 10px;border-radius:999px;box-shadow:0 4px 12px rgba(0,0,0,.15)}

/* celebration overlay */
#celebrate{
  position:fixed; inset:0; pointer-events:none; z-index:9999; opacity:.5; display:none;
}
.confetti, .flower{
  position:absolute; width:10px; height:10px; border-radius:2px;
  animation: poof .5s ease-out forwards;
}
.flower{
  width:12px; height:12px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #ffd700 0%, #ff6f00 60%, transparent 70%);
}
.confetti{ background: currentColor; }
@keyframes poof{
  0%{ transform: translate(0,0) scale(1); opacity:1; }
  100%{ transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(.6); opacity:0; }
}

/* ---------- BACKGROUND ---------- */
.ocean{
  position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.12;
  background:
    radial-gradient(circle at 20% 30%, #00a1ff 0%, rgba(0,161,255,.6) 12%, transparent 35%),
    radial-gradient(circle at 80% 70%, #0090ff 0%, rgba(0,144,255,.5) 15%, transparent 38%),
    radial-gradient(circle at 60% 20%, #00c2ff 0%, rgba(0,194,255,.5) 12%, transparent 34%),
    linear-gradient(180deg, #0077be 0%, #004c88 100%);
  background-size: 180% 180%;
  animation: drift 40s ease-in-out infinite alternate;
  filter: blur(14px) saturate(1.1);
}
@keyframes drift{
  0%{ background-position: 0% 0%, 100% 100%, 80% 0%, 50% 50%; }
  100%{ background-position: 100% 100%, 0% 0%, 20% 100%, 50% 60%; }
}
</style>
</head>
<body>
<div class="ocean" aria-hidden="true"></div>
<div id="celebrate"></div>

<div class="wrap">
  <div class="toolbar">
    <h1>UTM ⇄ Lat/Lon (WGS84) <span class="pill">Two-Way · Single File</span></h1>
    <div class="theme-ctl">
      <button id="themeBtn" class="theme-btn" aria-label="Toggle theme">
        <span id="themeIcon" class="ico" aria-hidden="true"></span>
        <span id="themeLabel">Theme</span>
      </button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT COLUMN: three stacked cards -->
    <div class="stack" style="flex-direction:column">
      <!-- Common Options -->
      <div class="card" id="commonCard">
        <div class="section-title">Common Options</div>
        <div class="row">
          <div style="flex:1 1 220px">
            <label>Conversion Mode</label>
            <select id="mode">
              <option value="utm2gcs" selected>UTM → Lat/Lon</option>
              <option value="gcs2utm">Lat/Lon → UTM</option>
            </select>
            <div class="hint">Switch direction any time.</div>
          </div>
          <div style="flex:1 1 180px">
            <label>Output format</label>
            <div class="row">
              <label><input type="radio" name="fmt" value="dd" checked> Decimal Degrees</label>
              <label><input type="radio" name="fmt" value="dms"> DMS</label>
            </div>
          </div>
        </div>
        <div id="zoneRow" class="row" style="margin-top:8px">
          <div style="flex:1 1 120px">
            <label>UTM Zone (1–60)</label>
            <input type="number" id="zone" min="1" max="60" value="43" />
          </div>
          <div style="flex:1 1 160px">
            <label>Hemisphere</label>
            <select id="hemi">
              <option value="N" selected>Northern</option>
              <option value="S">Southern</option>
            </select>
          </div>
          <div style="flex:1 1 220px">
            <label><input type="checkbox" id="autoZone" checked> Auto detect from map/search</label>
            <div class="hint">Auto-fills Zone & Hemisphere from picked location.</div>
          </div>
        </div>
      </div>

      <!-- Manual Card -->
      <div class="card" id="manualCard">
        <div class="section-title">Manual Conversion</div>

        <!-- MANUAL: UTM → GCS -->
        <div id="pane-utm2gcs">
          <div class="row">
            <div style="flex:1 1 120px">
              <label>Sr No (opt.)</label>
              <input type="text" id="mUtm-number" placeholder="e.g., 1" />
            </div>
            <div style="flex:2 1 180px">
              <label>Name (opt.)</label>
              <input type="text" id="mUtm-name" placeholder="e.g., TP-01" />
            </div>
          </div>
          <div class="row">
            <div style="flex:1 1 150px">
              <label>Easting* (m)</label>
              <input type="number" id="mUtm-east" step="any" placeholder="e.g., 238456.12" />
            </div>
            <div style="flex:1 1 150px">
              <label>Northing* (m)</label>
              <input type="number" id="mUtm-north" step="any" placeholder="e.g., 2401234.56" />
            </div>
            <div style="flex:1 1 120px">
              <label>Altitude (m)</label>
              <input type="number" id="mUtm-alt" step="any" placeholder="optional" />
            </div>
          </div>
          <div class="stack" style="margin-top:8px">
            <button class="btn" id="mUtmConvert">Convert Single</button>
            <button class="btn secondary" id="mUtmAdd">Add Point</button>
          </div>
        </div>

        <!-- MANUAL: GCS → UTM -->
        <div id="pane-gcs2utm" style="display:none">
          <div class="row">
            <div style="flex:1 1 120px">
              <label>Sr No (opt.)</label>
              <input type="text" id="mGcs-number" placeholder="e.g., 1" />
            </div>
            <div style="flex:2 1 180px">
              <label>Name (opt.)</label>
              <input type="text" id="mGcs-name" placeholder="e.g., TP-01" />
            </div>
          </div>
          <div class="row">
            <div style="flex:1 1 150px">
              <label>Latitude* (°)</label>
              <input type="number" id="mGcs-lat" step="any" placeholder="e.g., 21.7612" />
            </div>
            <div style="flex:1 1 150px">
              <label>Longitude* (°)</label>
              <input type="number" id="mGcs-lon" step="any" placeholder="e.g., 72.1534" />
            </div>
            <div style="flex:1 1 120px">
              <label>Altitude (m)</label>
              <input type="number" id="mGcs-alt" step="any" placeholder="optional" />
            </div>
          </div>
          <div class="stack" style="margin-top:8px">
            <button class="btn" id="mGcsConvert">Convert Single</button>
            <button class="btn secondary" id="mGcsAdd">Add Point</button>
          </div>
        </div>
      </div>

      <!-- CSV Card -->
      <div class="card" id="csvCard">
        <div class="section-title">CSV Upload</div>
        <input type="file" id="csv" accept=".csv" />
        <div class="hint">Map columns according to your selected mode.</div>

        <div style="height:10px"></div>
        <div class="section-title">Column Mapping</div>
        <!-- Mapping for UTM→GCS -->
        <div id="map-utm2gcs">
          <div class="row">
            <div style="flex:1 1 150px"><label>Sr No</label><select id="u2g-col-number"></select></div>
            <div style="flex:1 1 150px"><label>Name</label><select id="u2g-col-name"></select></div>
            <div style="flex:1 1 150px"><label>Easting*</label><select id="u2g-col-e"></select></div>
            <div style="flex:1 1 150px"><label>Northing*</label><select id="u2g-col-n"></select></div>
          </div>
          <div class="row">
            <div style="flex:1 1 150px"><label>Altitude</label><select id="u2g-col-alt"></select></div>
          </div>
        </div>
        <!-- Mapping for GCS→UTM -->
        <div id="map-gcs2utm" style="display:none">
          <div class="row">
            <div style="flex:1 1 150px"><label>Sr No</label><select id="g2u-col-number"></select></div>
            <div style="flex:1 1 150px"><label>Name</label><select id="g2u-col-name"></select></div>
            <div style="flex:1 1 150px"><label>Latitude*</label><select id="g2u-col-lat"></select></div>
            <div style="flex:1 1 150px"><label>Longitude*</label><select id="g2u-col-lon"></select></div>
          </div>
          <div class="row">
            <div style="flex:1 1 150px"><label>Altitude</label><select id="g2u-col-alt"></select></div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="stack">
          <button class="btn" id="convertBtn">Convert All</button>
          <button class="btn secondary" id="dlKml" disabled>Download KML (All)</button>
          <button class="btn secondary" id="dlCsv" disabled>Download CSV (All)</button>
          <button class="btn secondary" id="clearAll">Clear Results</button>
        </div>

        <div style="height:10px"></div>
        <div id="msg"></div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Map + preview -->
    <div class="card">
      <div class="section-title" style="margin:0 0 8px">Map & Preview</div>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <input type="text" id="searchBox" placeholder="Search place (e.g., Bhavnagar, India)" style="flex:1 1 320px">
        <button class="btn secondary" id="searchBtn">Search</button>
        <div class="hint">Click map or search to auto-fill Zone & Hemisphere (if enabled).</div>
      </div>

      <div id="map" class="map"></div>

      <div style="height:12px"></div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="section-title" style="margin:0">Results</div>
        <div class="hint">Updates after conversion</div>
      </div>
      <div id="preview" class="table-wrap"></div>

      <div style="height:10px"></div>
      <details>
        <summary>Troubleshooting</summary>
        <ul>
          <li>Ensure inputs are numeric (meters for UTM; degrees for lat/lon).</li>
          <li>Zone must be 1–60. Hemisphere N for lat ≥ 0, S for lat &lt; 0.</li>
          <li>Use the map/search to auto-detect zone/hemisphere if unsure.</li>
          <li>For Bhavnagar, typical: Zone 43N; lat ≈ 21°, lon ≈ 72°.</li>
        </ul>
      </details>
    </div>
  </div>
</div>

<!-- Credit -->
<div class="credit">(C) Vijay Parmar</div>

<!-- Minimal Leaflet (map) -->
<style>
  .leaflet-container{font:12px/1.5 Arial, Helvetica, sans-serif;}
  .leaflet-pane,.leaflet-tile,.leaflet-marker-icon,.leaflet-marker-shadow,.leaflet-tile-container,.leaflet-pane>svg,.leaflet-pane>canvas,.leaflet-zoom-box,.leaflet-image-layer,.leaflet-layer{position:absolute;left:0;top:0}
  .leaflet-control-zoom{box-shadow:0 1px 5px rgba(0,0,0,0.4);border-radius:4px}
  .leaflet-control-zoom a{background:#fff;border-bottom:1px solid #ddd;width:26px;height:26px;line-height:26px;text-align:center;display:block}
</style>
<script>
let L = null;
(async()=>{
  try{
    const css = document.createElement('link');
    css.rel='stylesheet';
    css.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(css);
    await new Promise(r=>css.onload=r);
    const s=document.createElement('script');
    s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    document.head.appendChild(s);
    await new Promise(r=>s.onload=r);
    L = window.L;
  }catch(e){ }
})();
</script>

<script>
/* ---------------- THEME ---------------- */
const THEME_KEY = 'themeOverride';
function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY, t); paintThemeButton(); }
function currentTheme(){ return document.documentElement.getAttribute('data-theme') || 'light'; }
function paintThemeButton(){
  const t = currentTheme();
  const icon = document.getElementById('themeIcon');
  const label = document.getElementById('themeLabel');
  label.textContent = (t==='dark'?'Dark':'Light');
  icon.innerHTML = (t==='dark'?
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>' :
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zM4.22 19.78l1.79-1.79-1.8-1.79-1.79 1.79 1.8 1.79zM13 1h-2v3h2V1zm7.83 3.83l-1.79-1.79-1.79 1.79 1.79 1.79 1.79-1.79zM20 11v2h3v-2h-3zm-3.76 8.16l1.8 1.79 1.79-1.79-1.8-1.79-1.79 1.79zM12 6a6 6 0 100 12 6 6 0 000-12z"/></svg>'
  );
}
window.addEventListener('DOMContentLoaded', ()=>{
  paintThemeButton();
  document.getElementById('themeBtn').addEventListener('click', ()=>{
    setTheme(currentTheme()==='dark'?'light':'dark');
  });
});

/* ---------------- HELPERS ---------------- */
const $ = (id)=>document.getElementById(id);
function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
function parseNum(val){ return parseFloat(String(val??'').replace(/,/g,'')); }
function toDMS(val, isLat){
  const v = Number(val); const hemi = (isLat? (v>=0?'N':'S') : (v>=0?'E':'W'));
  const av = Math.abs(v); const d = Math.floor(av); const mFloat = (av - d)*60; const m = Math.floor(mFloat); const s = (mFloat - m)*60;
  return `${d}° ${m}' ${s.toFixed(3)}" ${hemi}`;
}
function zoneFromLon(lon){ return Math.floor((lon + 180) / 6) + 1; } // ignores special cases
function hemiFromLat(lat){ return (lat>=0)? 'N' : 'S'; }
function escapeXml(s){ return String(s).replace(/[<&>"]/g, c=> ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c])); }

/* ---------------- CSV PARSER ---------------- */
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQ=false;
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else inQ=false; }
      else field+=c;
    } else {
      if(c==='"') inQ=true;
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n'||c==='\r'){ if(field!==''||row.length>0){ row.push(field); rows.push(row); row=[]; field=''; } if(c==='\r'&&text[i+1==='\n']) i++; }
      else field+=c;
    }
    i++;
  }
  if(field!==''||row.length>0){ row.push(field); rows.push(row); }
  return rows;
}

/* ---------------- PROJECTIONS (WGS84) ---------------- */
function utmToLatLon(easting, northing, zone, northern=true){
  const a=6378137.0; const f=1/298.257223563; const b=a*(1-f);
  const e2=(a*a-b*b)/(a*a); const ep2=(a*a-b*b)/(b*b); const k0=0.9996;
  let x=easting-500000.0; let y=northing; if(!northern) y-=10000000.0;
  const m=y/k0; const mu=m/(a*(1-e2/4-3*e2*e2/64-5*e2*e2*e2/256));
  const e1=(1-Math.sqrt(1-e2))/(1+Math.sqrt(1-e2));
  const j1=(3*e1/2-27*Math.pow(e1,3)/32), j2=(21*e1*e1/16-55*Math.pow(e1,4)/32), j3=(151*Math.pow(e1,3)/96), j4=(1097*Math.pow(e1,4)/512);
  const fp=mu + j1*Math.sin(2*mu) + j2*Math.sin(4*mu) + j3*Math.sin(6*mu) + j4*Math.sin(8*mu);
  const sinfp=Math.sin(fp), cosfp=Math.cos(fp), tanfp=Math.tan(fp);
  const c1=ep2*cosfp*cosfp, t1=tanfp*tanfp; const n1=a/Math.sqrt(1-e2*sinfp*sinfp); const r1=a*(1-e2)/Math.pow(1-e2*sinfp*sinfp,1.5);
  const d=(easting-500000.0)/(n1*k0);
  const lat = fp - (n1*tanfp/r1)*((d*d)/2 - (5+3*t1+10*c1-4*c1*c1-9*ep2)*Math.pow(d,4)/24 + (61+90*t1+298*c1+45*t1*t1-252*ep2-3*c1*c1)*Math.pow(d,6)/720);
  const lon = (d - (1+2*t1+c1)*Math.pow(d,3)/6 + (5-2*c1+28*t1-3*c1*c1+8*ep2+24*t1*t1)*Math.pow(d,5)/120)/cosfp;
  const lon0=(zone-1)*6-180+3;
  return { lat: lat*180/Math.PI, lon: lon*180/Math.PI + lon0 };
}

function latLonToUTM(latDeg, lonDeg, zoneOpt=null, hemiOpt=null){
  const a=6378137.0; const f=1/298.257223563; const e2 = f*(2-f); const ep2 = e2/(1-e2); const k0=0.9996;
  const lat = latDeg*Math.PI/180, lon = lonDeg*Math.PI/180;

  // Zone & hemisphere (auto if not provided)
  const zone = zoneOpt ?? zoneFromLon(lonDeg);
  const hemi = hemiOpt ?? hemiFromLat(latDeg);
  const northern = (hemi==='N');

  const lon0deg = (zone-1)*6 - 180 + 3;
  const lon0 = lon0deg*Math.PI/180;
  const N = a/Math.sqrt(1 - e2*Math.sin(lat)**2);
  const T = Math.tan(lat)**2;
  const C = ep2*Math.cos(lat)**2;
  const A = (lon - lon0)*Math.cos(lat);

  // Meridional arc
  const b=a*(1-f);
  const n = (a-b)/(a+b);
  const A0 = 1 + (n*n)/4 + (n**4)/64;
  const A2 = (3/2)*(n - (n**3)/8);
  const A4 = (15/16)*(n*n - (n**4)/4);
  const A6 = (35/48)*(n**3);
  const A8 = (315/512)*(n**4);
  const m = b*A0*lat - b*A2*Math.sin(2*lat) + b*A4*Math.sin(4*lat) - b*A6*Math.sin(6*lat) + b*A8*Math.sin(8*lat);

  const easting = k0*N*( A + (1-T+C)*A**3/6 + (5-18*T+T**2+72*C-58*ep2)*A**5/120 ) + 500000.0;
  let northing = k0*( m + N*Math.tan(lat)*( A**2/2 + (5-T+9*C+4*C**2)*A**4/24 + (61-58*T+T**2+600*C-330*ep2)*A**6/720 ) );
  if(!northern) northing += 10000000.0;

  return { easting, northing, zone, hemi };
}

/* ---------------- STATE ---------------- */
let csvRows=null, headers=[], dataRows=[], lastResults=[];
let map = null, mapMarker = null, resultsGroup = null;
const ORANGE_STYLE = { radius: 7, color: '#ff8c00', fillColor: '#ff8c00', fillOpacity: 0.9, weight: 2 };

/* ---------------- CELEBRATION ---------------- */
function celebrate(){
  const box = document.getElementById('celebrate');
  box.innerHTML='';
  box.style.display='block';
  const W = window.innerWidth, H = window.innerHeight;
  const colors = ['#ff4d4f','#ff9800','#ffd700','#4caf50','#2196f3','#9c27b0'];
  // confetti
  for(let i=0;i<50;i++){
    const d = document.createElement('div');
    d.className='confetti';
    d.style.left = (W/2)+'px';
    d.style.top = (H/2)+'px';
    d.style.color = colors[i%colors.length];
    const angle = Math.random()*2*Math.PI;
    const dist = 120 + Math.random()*220;
    const tx = Math.cos(angle)*dist;
    const ty = Math.sin(angle)*dist;
    const rot = (Math.random()*720-360)+'deg';
    d.style.setProperty('--tx', tx+'px');
    d.style.setProperty('--ty', ty+'px');
    d.style.setProperty('--rot', rot);
    box.appendChild(d);
  }
  // flowers
  for(let i=0;i<16;i++){
    const d = document.createElement('div');
    d.className='flower';
    d.style.left = (W/2)+'px';
    d.style.top = (H/2)+'px';
    const angle = Math.random()*2*Math.PI;
    const dist = 100 + Math.random()*200;
    const tx = Math.cos(angle)*dist;
    const ty = Math.sin(angle)*dist;
    d.style.setProperty('--tx', tx+'px');
    d.style.setProperty('--ty', ty+'px');
    d.style.setProperty('--rot', '0deg');
    box.appendChild(d);
  }
  setTimeout(()=>{ box.style.display='none'; box.innerHTML=''; }, 600); // ~0.5s
}

/* ---------------- UI RENDERERS ---------------- */
function renderTable(rows, mode){
  const prev=$('preview'); clear(prev);
  const table=document.createElement('table');
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  const cols = (mode==='utm2gcs')
    ? ['Number','Name','Latitude','Longitude','Altitude','Zone','Hemisphere','Easting','Northing']
    : ['Number','Name','Easting','Northing','Altitude','Zone','Hemisphere','Latitude','Longitude'];
  cols.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tb=document.createElement('tbody');
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    cols.forEach(k=>{ const td=document.createElement('td'); td.textContent=(r[k]??''); tr.appendChild(td); });
    tb.appendChild(tr);
  });
  table.appendChild(tb); prev.appendChild(table);
}

function enableDownloads(rows){
  if(!rows.length){ $('dlCsv').disabled=true; $('dlKml').disabled=true; return; }
  // CSV uses displayed fields
  const headersOut = Object.keys(rows[0]).filter(k=> !k.startsWith('_'));
  const csv=[headersOut.join(',')].concat(rows.map(r=> headersOut.map(h=>{
    const v=r[h]; if(v===null||v===undefined) return ''; const s=String(v);
    return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s;
  }).join(','))).join('\n');
  const csvBlob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const csvUrl=URL.createObjectURL(csvBlob);
  const dlCsvBtn=$('dlCsv'); dlCsvBtn.disabled=false; dlCsvBtn.onclick=()=>{ downloadLink(csvUrl,'converted.csv'); };

  // KML uses numeric lat/lon
  const kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2"><Document>\n` +
    rows.map(r=>{
      const lon = (typeof r._lon==='number') ? r._lon : (typeof r.Longitude==='number'? r.Longitude : '');
      const lat = (typeof r._lat==='number') ? r._lat : (typeof r.Latitude==='number'? r.Latitude : '');
      const alt = (r.Altitude!=='' && r.Altitude!==undefined && r.Altitude!==null) ? r.Altitude : 0;
      const nm = escapeXml(r.Name||r.Number||'point');
      return `<Placemark><name>${nm}</name><Point><coordinates>${lon},${lat},${alt}</coordinates></Point></Placemark>`;
    }).join('\n') + `\n</Document></kml>`;
  const kmlBlob=new Blob([kml],{type:'application/vnd.google-earth.kml+xml'}); const kmlUrl=URL.createObjectURL(kmlBlob);
  const dlKmlBtn=$('dlKml'); dlKmlBtn.disabled=false; dlKmlBtn.onclick=()=>{ downloadLink(kmlUrl,'points.kml'); };
}
function downloadLink(url, filename){ const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0); }

/* ---------------- MODE SWITCHING ---------------- */
function switchMode(){
  const mode = $('mode').value;
  $('pane-utm2gcs').style.display = (mode==='utm2gcs')?'':'none';
  $('pane-gcs2utm').style.display = (mode==='gcs2utm')?'':'none';
  $('map-utm2gcs').style.display = (mode==='utm2gcs')?'':'none';
  $('map-gcs2utm').style.display = (mode==='gcs2utm')?'':'none';
  // Show zone/hemisphere row only for UTM→GCS
  $('zoneRow').style.display = (mode==='utm2gcs') ? '' : 'none';
  // Message
  $('msg').innerHTML = `<div class="hint">Mode changed to <b>${mode==='utm2gcs'?'UTM → Lat/Lon':'Lat/Lon → UTM'}</b>.</div>`;
  // Re-render under new column order
  if(lastResults.length) renderTable(lastResults, mode);
}
$('mode').addEventListener('change', switchMode);

/* ---------------- CSV FLOW ---------------- */
$('csv').addEventListener('change', async (e)=>{
  const f=e.target.files&&e.target.files[0]; if(!f){ csvRows=null; headers=[]; dataRows=[]; return; }
  const text = await f.text();
  const rows = parseCSV(text).filter(r=> r.length && r.some(x=> String(x).trim()!==''));
  if(!rows.length){ $('msg').innerHTML = `<div class="error">Empty CSV.</div>`; return; }
  csvRows=rows; headers=rows[0].map(h=> String(h).trim()); dataRows=rows.slice(1);
  fillMappingSelects();
  $('msg').innerHTML = `<div class="success">Loaded <b>${dataRows.length}</b> rows. Map the columns and click <b>Convert All</b>.</div>`;
});

function smartFind(headers, keys){
  const idx = headers.findIndex(h=> keys.some(k=> h.toLowerCase().replace(/\s|_/g,'').includes(k)) );
  return idx>=0? headers[idx] : '';
}
function fillMappingSelects(){
  const addOptions = (sel, list) => {
    clear(sel);
    const opt=document.createElement('option'); opt.value=''; opt.textContent='— Not used —'; sel.appendChild(opt);
    list.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h; sel.appendChild(o); });
  };
  // UTM->GCS
  ['u2g-col-number','u2g-col-name','u2g-col-e','u2g-col-n','u2g-col-alt']
    .map($).forEach(sel=> addOptions(sel, headers));
  $('u2g-col-e').value = smartFind(headers, ['easting','east','utme','utmxe','utm x','utm-e']);
  $('u2g-col-n').value = smartFind(headers, ['northing','north','utmn','utm y','utm-n']);
  $('u2g-col-number').value = smartFind(headers, ['srno','no','number','id']);
  $('u2g-col-name').value   = smartFind(headers, ['name','label','point','pt']);
  $('u2g-col-alt').value    = smartFind(headers, ['alt','altitude','height','elev','elevation','z']);
  // GCS->UTM
  ['g2u-col-number','g2u-col-name','g2u-col-lat','g2u-col-lon','g2u-col-alt']
    .map($).forEach(sel=> addOptions(sel, headers));
  $('g2u-col-lat').value = smartFind(headers, ['lat','latitude']);
  $('g2u-col-lon').value = smartFind(headers, ['lon','long','longitude']);
  $('g2u-col-number').value = smartFind(headers, ['srno','no','number','id']);
  $('g2u-col-name').value   = smartFind(headers, ['name','label','point','pt']);
  $('g2u-col-alt').value    = smartFind(headers, ['alt','altitude','height','elev','elevation','z']);
}

$('convertBtn').addEventListener('click', ()=>{
  const mode = $('mode').value, msgEl=$('msg');
  const zone=Number($('zone').value), hemi=$('hemi').value, northern=(hemi==='N');
  if(mode==='utm2gcs' && !(zone>=1&&zone<=60)){ msgEl.innerHTML = `<div class="error">Zone must be 1–60.</div>`; return; }

  const out=[]; const fmt=document.querySelector('input[name="fmt"]:checked').value;
  const hIndex=Object.fromEntries(headers.map((h,i)=>[h,i]));

  if(mode==='utm2gcs'){
    const ce=$('u2g-col-e').value, cn=$('u2g-col-n').value; if(!ce||!cn){ msgEl.innerHTML = `<div class="error">Map Easting and Northing.</div>`; return; }
    const ci={ number:$('u2g-col-number').value||null, name:$('u2g-col-name').value||null, e:ce, n:cn, alt:$('u2g-col-alt').value||null };

    for(const r of dataRows){
      const eStr=r[hIndex[ci.e]]??''; const nStr=r[hIndex[ci.n]]??'';
      const e=parseNum(eStr), n=parseNum(nStr); if(!isFinite(e)||!isFinite(n)) continue;
      const {lat,lon}=utmToLatLon(e,n,zone,northern);
      const useLat = fmt==='dms'? toDMS(lat,true) : lat.toFixed(16);
      const useLon = fmt==='dms'? toDMS(lon,false): lon.toFixed(16);
      out.push({
        Number: ci.number? r[hIndex[ci.number]]:'', 
        Name:   ci.name?   r[hIndex[ci.name]]  :'',
        Latitude: useLat, Longitude: useLon, Altitude: ci.alt? r[hIndex[ci.alt]] :'',
        Zone: zone, Hemisphere: hemi, Easting: e, Northing: n,
        _lat: lat, _lon: lon
      });
    }
  } else { // gcs2utm
    const clat=$('g2u-col-lat').value, clon=$('g2u-col-lon').value; if(!clat||!clon){ msgEl.innerHTML = `<div class="error">Map Latitude and Longitude.</div>`; return; }
    const ci={ number:$('g2u-col-number').value||null, name:$('g2u-col-name').value||null, lat:clat, lon:clon, alt:$('g2u-col-alt').value||null };

    for(const r of dataRows){
      const lat=parseNum(r[hIndex[ci.lat]]), lon=parseNum(r[hIndex[ci.lon]]);
      if(!isFinite(lat)||!isFinite(lon)) continue;
      const auto = $('autoZone').checked;
      const z = auto ? zoneFromLon(lon) : Number($('zone').value);
      const h = auto ? hemiFromLat(lat) : $('hemi').value;
      const {easting, northing} = latLonToUTM(lat, lon, z, h);
      out.push({
        Number: ci.number? r[hIndex[ci.number]]:'', 
        Name:   ci.name?   r[hIndex[ci.name]]  :'',
        Easting: Number(easting.toFixed(3)), Northing: Number(northing.toFixed(3)), Altitude: ci.alt? r[hIndex[ci.alt]] :'',
        Zone: z, Hemisphere: h,
        Latitude: (fmt==='dms'? toDMS(lat,true) : lat.toFixed(16)),
        Longitude:(fmt==='dms'? toDMS(lon,false): lon.toFixed(16)),
        _lat: lat, _lon: lon
      });
    }
  }

  if(!out.length){ msgEl.innerHTML = `<div class="error">No valid rows found.</div>`; return; }
  lastResults = out;
  renderTable(out, mode);
  enableDownloads(out);
  plotOnMap(out);
  msgEl.innerHTML = `<div class="success">Converted <b>${out.length}</b> row(s).</div>`;
  celebrate();
});

/* ---------------- MANUAL CONVERT ---------------- */
function currentFmt(){ return document.querySelector('input[name="fmt"]:checked').value; }

$('mUtmConvert').addEventListener('click', ()=> convertManualUtm(false));
$('mUtmAdd').addEventListener('click', ()=> convertManualUtm(true));
function convertManualUtm(addMode){
  const zone=Number($('zone').value); const hemi=$('hemi').value; const northern=(hemi==='N');
  const e=parseNum($('mUtm-east').value), n=parseNum($('mUtm-north').value);
  const alt=$('mUtm-alt').value? parseNum($('mUtm-alt').value) : '';
  const sr=$('mUtm-number').value.trim(); const name=$('mUtm-name').value.trim();
  if(!(zone>=1&&zone<=60)) return $('msg').innerHTML=`<div class="error">Zone must be 1–60.</div>`;
  if(!isFinite(e)||!isFinite(n)) return $('msg').innerHTML=`<div class="error">Enter numeric Easting/Northing.</div>`;
  const {lat,lon}=utmToLatLon(e,n,zone,northern);
  const fmt=currentFmt();
  const row={
    Number: sr||'', Name:name||'',
    Latitude: (fmt==='dms'? toDMS(lat,true) : lat.toFixed(16)),
    Longitude:(fmt==='dms'? toDMS(lon,false): lon.toFixed(16)),
    Altitude: alt, Zone: zone, Hemisphere: hemi, Easting:e, Northing:n,
    _lat:lat, _lon:lon
  };
  if(addMode){ lastResults.push(row); $('msg').innerHTML=`<div class="success">Added 1 point. Total <b>${lastResults.length}</b>.</div>`; }
  else { lastResults=[row]; $('msg').innerHTML=`<div class="success">Converted single point.</div>`; celebrate(); }
  renderTable(lastResults, 'utm2gcs'); enableDownloads(lastResults); plotOnMap(lastResults);
}

$('mGcsConvert').addEventListener('click', ()=> convertManualGcs(false));
$('mGcsAdd').addEventListener('click', ()=> convertManualGcs(true));
function convertManualGcs(addMode){
  let lat=parseNum($('mGcs-lat').value), lon=parseNum($('mGcs-lon').value);
  const alt=$('mGcs-alt').value? parseNum($('mGcs-alt').value) : '';
  const sr=$('mGcs-number').value.trim(); const name=$('mGcs-name').value.trim();
  if(!(isFinite(lat)&&isFinite(lon) && lat>=-90 && lat<=90 && lon>=-180 && lon<=180))
    return $('msg').innerHTML=`<div class="error">Enter valid Latitude (−90..90) and Longitude (−180..180).</div>`;
  const auto = $('autoZone').checked;
  const z = auto ? zoneFromLon(lon) : Number($('zone').value);
  const h = auto ? hemiFromLat(lat) : $('hemi').value;
  const {easting, northing} = latLonToUTM(lat, lon, z, h);
  const fmt=currentFmt();
  const row={
    Number: sr||'', Name:name||'',
    Easting: Number(easting.toFixed(3)), Northing: Number(northing.toFixed(3)),
    Altitude: alt, Zone: z, Hemisphere: h,
    Latitude: (fmt==='dms'? toDMS(lat,true) : lat.toFixed(16)),
    Longitude:(fmt==='dms'? toDMS(lon,false): lon.toFixed(16)),
    _lat: lat, _lon: lon
  };
  if(addMode){ lastResults.push(row); $('msg').innerHTML=`<div class="success">Added 1 point. Total <b>${lastResults.length}</b>.</div>`; }
  else { lastResults=[row]; $('msg').innerHTML=`<div class="success">Converted single point.</div>`; celebrate(); }
  renderTable(lastResults, 'gcs2utm'); enableDownloads(lastResults); plotOnMap(lastResults);
}

$('clearAll').addEventListener('click', ()=>{
  lastResults = []; clear($('preview')); $('dlCsv').disabled=true; $('dlKml').disabled=true;
  if(resultsGroup && map){ resultsGroup.clearLayers(); map.removeLayer(resultsGroup); resultsGroup=null; }
  if(mapMarker && map){ map.removeLayer(mapMarker); mapMarker=null; }
  $('msg').innerHTML = `<div class="success">Cleared results.</div>`;
});

/* ---------------- MAP + SEARCH ---------------- */
async function initMap(){
  if(!L){ $('map').innerHTML='<div class="hint" style="padding:10px">Map unavailable offline. Conversions still work.</div>'; return; }
  map = L.map('map').setView([21.76,72.15], 6);

  // Bhuvan base (NRSC/ISRO). If it fails, keep map empty but usable.
  const bhuvan = L.tileLayer('https://bhuvan-app1.nrsc.gov.in/tilecache/tilecache.py/1.0.0/bhuvan_base/{z}/{x}/{y}.jpg', {
    maxZoom: 18, attribution: '© NRSC/ISRO Bhuvan'
  }).addTo(map);

  map.on('click', (ev)=>{
    const {lat,lng} = ev.latlng;
    // Auto set zone/hemi only if "UTM → GCS" requires it OR user wants auto for gcs2utm
    if($('autoZone').checked){
      const z = zoneFromLon(lng), h = hemiFromLat(lat);
      $('zone').value = z; $('hemi').value = h;
      $('msg').innerHTML = `<div class="success">Picked map location → Zone <b>${z}${h}</b> set automatically.</div>`;
    }
    placeMarker(lat,lng);
  });
}
function placeMarker(lat, lon){
  if(!map) return;
  if(mapMarker) map.removeLayer(mapMarker);
  mapMarker = L.marker([lat,lon]).addTo(map);
}
window.addEventListener('load', ()=>{
  switchMode(); // initialize panel visibility
  initMap();
});

document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = $('searchBox').value.trim(); if(!q) return;
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    const js = await res.json();
    if(js && js.length){
      const lat = parseFloat(js[0].lat), lon = parseFloat(js[0].lon);
      if(map){ map.setView([lat,lon], 12); placeMarker(lat,lon); }
      if($('autoZone').checked){
        const z = zoneFromLon(lon), h = hemiFromLat(lat);
        $('zone').value = z; $('hemi').value = h;
        $('msg').innerHTML = `<div class="success">Search: set Zone <b>${z}${h}</b> from “${q}”.</div>`;
      }
    } else {
      $('msg').innerHTML = `<div class="error">No results for “${q}”. Try a more precise name.</div>`;
    }
  }catch(err){
    $('msg').innerHTML = `<div class="error">Search failed. Check internet connection.</div>`;
  }
});

/* ---------------- RESULTS ON MAP (ORANGE MARKERS) ---------------- */
function plotOnMap(rows){
  if(!map || !L) return; // map not ready
  // Clear previous results
  if(resultsGroup){ resultsGroup.clearLayers(); map.removeLayer(resultsGroup); }
  resultsGroup = L.layerGroup().addTo(map);

  const pts=[];
  rows.forEach(r=>{
    const lat = (typeof r._lat==='number') ? r._lat : (typeof r.Latitude==='number'? r.Latitude : null);
    const lon = (typeof r._lon==='number') ? r._lon : (typeof r.Longitude==='number'? r.Longitude : null);
    if(typeof lat==='number' && typeof lon==='number'){
      const m = L.circleMarker([lat,lon], ORANGE_STYLE).addTo(resultsGroup);
      const label = r.Name || r.Number || '';
      m.bindPopup(`<b>${escapeXml(label)}</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}`);
      pts.push([lat,lon]);
    }
  });
  if(pts.length){
    try{ map.fitBounds(L.latLngBounds(pts).pad(0.2)); }catch(e){}
  }
}
</script>
</body>
</html>
